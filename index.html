<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Icon Power-Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .toast-animate { animation: slideUp 0.3s ease-out, fadeOut 0.3s ease-in 1.7s forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center py-10 px-4 font-sans">

    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6 relative">
        <h1 class="text-2xl font-bold text-gray-800 mb-1 text-center">iOS Icon Toolkit</h1>
        <div class="flex flex-wrap justify-center gap-2 text-[10px] uppercase tracking-wider text-gray-400 mb-6 font-bold">
            <span class="bg-gray-100 px-2 py-1 rounded">Enter: Search</span>
            <span class="bg-gray-100 px-2 py-1 rounded">Cmd/Ctrl + C: Copy</span>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
            <label class="block text-sm font-semibold text-gray-600 mb-1">Target Resolution</label>
            <div class="flex items-center gap-2">
                <input type="number" id="sizeSetting" class="w-full px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <span class="text-gray-400 font-medium">px</span>
            </div>
        </div>

        <div class="flex gap-2 mb-6">
            <input type="text" id="appInput" placeholder="App Name..." 
                class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">
            <button id="searchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 rounded-xl transition font-bold">Search</button>
        </div>

        <div id="resultArea" class="hidden flex flex-col items-center border-t pt-6 text-center">
            <img id="iconPreview" src="" class="w-48 h-48 rounded-[22%] shadow-2xl mb-6 bg-gray-50 border border-gray-100">
            <h2 id="appName" class="text-xl font-bold text-gray-800 mb-6"></h2>
            
            <div class="grid grid-cols-2 gap-4 w-full">
                <button id="copyBtn" class="bg-slate-800 hover:bg-black text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                    Copy Image
                </button>
                <a id="downloadBtn" href="#" download="icon.jpg" 
                   class="bg-blue-600 hover:bg-blue-700 text-white text-center py-3 rounded-xl font-bold transition">
                    Download
                </a>
            </div>
        </div>

        <p id="statusMsg" class="text-center text-sm text-gray-500 hidden mt-4 italic"></p>
    </div>

    <div id="toast" class="fixed bottom-10 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl hidden z-50 font-medium tracking-wide">
        ✅ Copied to clipboard!
    </div>

    <canvas id="resizeCanvas" style="display:none;"></canvas>

    <script>
        const sizeInput = document.getElementById('sizeSetting');
        const appInput = document.getElementById('appInput');
        const searchBtn = document.getElementById('searchBtn');
        const copyBtn = document.getElementById('copyBtn');
        const statusMsg = document.getElementById('statusMsg');
        const resultArea = document.getElementById('resultArea');
        const toast = document.getElementById('toast');

        window.onload = () => {
            sizeInput.value = localStorage.getItem('iconSize') || 512;
            appInput.focus();
        };

        sizeInput.addEventListener('input', () => localStorage.setItem('iconSize', sizeInput.value));

        function showToast(message) {
            toast.innerText = message;
            toast.classList.remove('hidden', 'toast-animate');
            void toast.offsetWidth; // Trigger reflow
            toast.classList.add('toast-animate');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }

        async function fetchIcon() {
            const query = appInput.value.trim();
            if (!query) return;

            resultArea.classList.add('hidden');
            statusMsg.innerText = "Searching...";
            statusMsg.classList.remove('hidden');

            try {
                const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=software&limit=1`);
                const data = await response.json();

                if (data.results.length > 0) {
                    const app = data.results[0];
                    const rawUrl = app.artworkUrl512.replace('512x512bb', '1024x1024bb');
                    
                    const imgResponse = await fetch(rawUrl);
                    const blob = await imgResponse.blob();
                    const objectURL = URL.createObjectURL(blob);

                    document.getElementById('iconPreview').src = objectURL;
                    document.getElementById('appName').innerText = app.trackName;
                    document.getElementById('downloadBtn').href = objectURL;
                    document.getElementById('downloadBtn').download = `${app.trackName}-icon.jpg`;

                    statusMsg.classList.add('hidden');
                    resultArea.classList.remove('hidden');
                } else {
                    statusMsg.innerText = "No results found.";
                }
            } catch (e) {
                statusMsg.innerText = "Connection error.";
            }
        }

        async function performCopy() {
            if (resultArea.classList.contains('hidden')) return;

            const size = parseInt(sizeInput.value) || 512;
            const canvas = document.getElementById('resizeCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = async () => {
                canvas.width = size;
                canvas.height = size;
                ctx.drawImage(img, 0, 0, size, size);
                
                canvas.toBlob(async (blob) => {
                    try {
                        const data = [new ClipboardItem({ "image/png": blob })];
                        await navigator.clipboard.write(data);
                        showToast(`✅ ${size}x${size} Icon Copied!`);
                    } catch (err) {
                        alert("Clipboard error. GitHub Pages must be on HTTPS.");
                    }
                }, 'image/png');
            };
            img.src = document.getElementById('iconPreview').src;
        }

        // Search Listeners
        appInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchIcon(); });
        searchBtn.addEventListener('click', fetchIcon);

        // Shortcut Listener (Cmd+C or Ctrl+C)
        window.addEventListener('keydown', (e) => {
            const isCmdOrCtrl = e.metaKey || e.ctrlKey;
            if (isCmdOrCtrl && e.code === 'KeyC') {
                // If text is selected in the input, don't override the default copy
                if (window.getSelection().toString().length > 0) return;
                
                e.preventDefault();
                performCopy();
            }
        });

        copyBtn.addEventListener('click', performCopy);
    </script>
</body>
</html>
